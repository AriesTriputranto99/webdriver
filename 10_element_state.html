<section>
<h2>Reading Element State</h2>
  <p></p>
  <section>
    <a name="visibility"><h2>Determining Visibility</h2></a>
      <p>The following algorithm is used to determine if an element has been displayed.</p>
      <ul>
        <li>The element has a height and width greater than 0px.</li>
        <li>The element MUST not be visible if that element, or any of its ancestors,
        is hidden or has a display property that is none.</li>
        <li>OPTIONs and OPTGROUP are treated as special cases, they are considered shown if and
        only if the enclosing select element is visible.</li>
        <li>MAP elements are shown if and only if the image it uses is visible. Areas within
        a map are shown if the enclosing MAP is visible.</li>
        <li>Any INPUT elements of "type=hidden" are not visible</li>
        <li>Any NOSCRIPT elements MUST not be visible if Javascript is enabled.</li>
        <li>The element MUST be not be visible if their ancestor has a fixed size AND has the
        CSS style of "overflow:hidden" and the element's location is not within the fixed
        size of the parent</li>
      </ul>
    <table>
      <tr>
        <td>Command Name</td>
        <td>isDisplayed</td>
      </tr>
      <tr>
        <td>Parameters</td>
        <td>"id" {string} The ID of the WebElement on which to operate.
        </td>
      </tr>
      <tr>
        <td>Return Value</td>
        <td>{boolean} Whether the element is displayed.</td>
      </tr>
      <tr>
        <td>Throws</td>
        <td>StaleElementReferenceException if the element referenced is no longer attached to
          the DOM</td>
      </tr>
    </table>
  </section>
  <section>
    <h2>Reading Attributes and Properties</h2>

<p>Although the [[!HTML5]] spec is very clear about the difference between the properties and attributes of a DOM element, users are frequently confused between the two. Because of this, the WebDriver API offers a single command ("getElementAttribute") which covers the case of returning both the value of a DOM element's property or attribute. If a user wishes to refer specifically to an attribute or a property, they should evaluate Javascript in order to be unambiguous.</p>

<p>In order to implement the "getElementAttribute" command, a series of sub functions are needed. These are detailed below.</p>

<section>
<h2>Reading an Attribute</h2>
    
<p>Reading an attribute is equivalent to calling the Javascript "getAttribute" function on an element, with the following exceptions:
<ul>
    <li>The "style" attribute MUST return the same value as if the "style" property was requested (see below).</li>
    <li>If the attribute represents a boolean and the attribute name is listed below the null value MUST be returned if the attribute is false, otherwise the string 'true' MUST be returned.</li>
    <li>If the attribute name represents a boolean and the attribute is not listed below, the null value SHOULD be returned if the attribute is false, otherwise the string 'true' SHOULD be returned.</li>
</ul>
</p>
<p>The following are considered boolean attributes:
<ul>
   <li>async</li>
    <li>autofocus</li>
    <li>autoplay</li>
    <li>checked</li>
    <li>compact</li>
    <li>complete</li>
    <li>controls</li>
    <li>declare</li>
    <li>defaultchecked</li>
    <li>defaultselected</li>
    <li>defer</li>
    <li>disabled</li>
    <li>draggable</li>
    <li>ended</li>
    <li>formnovalidate</li>
    <li>hidden</li>
    <li>indeterminate</li>
    <li>iscontenteditable</li>
    <li>ismap</li>
    <li>itemscope</li>
    <li>loop</li>
    <li>multiple</li>
    <li>muted</li>
    <li>nohref</li>
    <li>noresize</li>
    <li>noshade</li>
    <li>novalidate</li>
    <li>nowrap</li>
    <li>open</li>
    <li>paused</li>
    <li>pubdate</li>
    <li>readonly</li>
    <li>required</li>
    <li>reversed</li>
    <li>scoped</li>
    <li>seamless</li>
    <li>seeking</li>
    <li>selected</li>
    <li>spellcheck</li>
    <li>truespeed</li>
    <li>willvalidate</li>
</ul>
</p>
</section>

<section>
    <h2>Reading a Property</h2>

<p>A DOM element property may be read using the equivalent of the Javascript "return element['propertyName']" with the null value being returned when there is no match. The following exceptions MUST be made:
        
    <ul>
        <li>For a property that is marked as boolean in [[!HTML5]] the boolean value "true" or "false" MUST be returned. If a document is using HTML5, then the section on <a href="http://www.w3.org/TR/html5/Overview.html#boolean-attributes">boolean attributes</a> from the [[!HTML5]] spec MUST be followed. If the document is using a prior version of HTML, then "false" is returned iff the value of the property is equal to undefined.</li>
        <li>If the element is an OPTION element and the property name is "value" and there is no "value" attribute, then the text content of the OPTION element MUST be returned, in accordance with [[!HTML401]] spec, specifically the section on <a href="http://www.w3.org/TR/1999/REC-html401-19991224/interact/forms.html#adef-value-OPTION">pre-selected options</a>. The text content MUST be the result of calling the "getElementText" command on the OPTION element.</li>
    </ul>
</p>
    
<p>If no property matches and the desired property name is in the table below, a WebDriver implementation MUST return the result of getting the aliased property.</p>

    <table>
        <tr>
            <th>Original property name</th>
            <th>Aliased property name</th>
        </tr>
        <tr>
            <td>class</td>
            <td>className</td>
        </tr>
        <tr>
            <td>readonly</td>
            <td>readOnly</td>
        </tr>
    </table>

<p class="note">These aliases provide the commonly used names for element properties.</p>

<section>
<h2>The "style" Property</h2>

<p>The "style" property MUST be <a href="http://dev.w3.org/csswg/cssom/#serialize-a-css-rule">serialized as defined</a> in the [[!CSSOM]] spec. Notably, css property names MUST be cased the same as specified in in section 6.5.1 of the [[!CSSOM]] spec.</p>

<p>Consequently, it SHOULD be equivalent to obtaining the "cssText" property, with the additional constraint that the same value MUST be returned after a round trip through "executeScript". That is, the following pseudo-code MUST be true (where "driver" is a WebDriver instance, and "element" is a WebElement):</p>

<pre class="code">
var style = element.getAttribute('style');
driver.executeScript('arguments[0].style = arguments[1]', element, style);
var recovered = element.getAttribute('style');
assertEquals(style, recovered);
</pre>

</section>
</section>
      
<section>
<a name="selectable"><h2>Determining Whether a WebElement Is Selected</h2></a>
    
<p>WebDriver determines whether a WebElement is selected using the following algorithm:

<ol>
    <li><a href="is_selectable"></a>If the item is not "selectable", the WebElement is not selected. A selectable element is either an OPTION element or an INPUT element of type "checkbox" or "radio".</li> 
    <li>If the WebElement represents an INPUT element, call the "getProperty" method described above looking for the "checked" property. This indicates whether the element is selected.</li>
    <li>Otherwise, call the "getProperty" method described above looking for the "selected" property. This indicates whether the element is selected.</li>
</ol>

</p>    
</section>

<section>
<h2>The "getElementAttribute" Command</h2>
<table>
	<tr>
		<td>Command Name</td>
		<td>getElementAttribute</td>
	</tr>
	<tr>
		<td>Parameters</td>
		<td>"sessionId" {string} The key that identifies which session this request is for.<br/>
		    "id" {string} The ID of the WebElement on which to operate.</br>
		    "name" {string} The name of the property of attribute to return.</td>
		</td>
	</tr>
	<tr>
	    <td>Return Value</td>
	    <td>{string|null}</td>
	</tr>
	<tr>
	    <td>Throws</td>
	    <td>StaleElementException If the element is no longer attached to the DOM.</td>
	</tr>
</table>

<p>The "getElementAttribute" command depends on the functions described above. The algorithm to use MUST be:

<ol>
    <li>Examine the combination of WebElement tag name and the attribute name to determine whether the return value is expected to be a URL.</li>
    <li>If the combination is one that expects a URL:
        <ol>
            <li>Get the named attribute using the algorithm described above.</li>
            <li>If there is a value, return the named property using the algorithm described above.</li>
            <li>Otherwise, return null.
        </ol>
    </li>
    <li>If the named attribute case insensitively matches "selected" or "checked" and the WebElement is selectable (as detailed in <a href="#is_selectable">the first bullet point of determining whether a WebElement is selected</a>), get the value determined by that algorithm. Return the string "true" if the result is true, or the null value if false.</li>
    <li>Get the value of the named property using the algorithm above.</li>
    <li>If the returned value is defined, not null and not an object, return the value coerced into a string.</li>
    <li>Get the value of the named attribute using the algorithm above.</li>
    <li>If the value is defined and not null, return the value coerced into a string.</li>
    <li>Otherwise return null.</li>
</ol>
</p>

<p>The following combination of WebElement tag names and values for "name" are considered to return a URL value:
    <strong>TODO: This doesn't feel like an exhaustive list</strong>

<table>
    <tr>
        <th>Tag name</th>
        <th>"name" value</th>
    </tr>
    <tr>
        <td>A</td>
        <td>href</td>
    </tr>
    <tr>
        <td>IMG</td>
        <td>src</td>
    </tr>
</table>
    
</p>

    </section>
</section>

<section>
   <h2>Rendering Text</h2>
   <p>All WebDriver implementations must support getting the <a href="#visibility">visible</a> text of a WebElement, with excess whitespace compressed.</p>
   
<p>The following definitions are used in this section:
    <dl>
        <dt><a name="text.whitespace">Whitespace</a></dt>
        <dd>Any text that matches the ECMAScript regular expression class <code>\s</code>.
        
        <dt><a name="text.whitespace-nbsp">Whitespace excluding non-breaking spaces</a></dt>
        <dd>Any text that matches the ECMAScript regular expression <code>[^\S\xa0]</code>
            
        <dt><a name="text.blocklevel">Block level element</a></dt>
        <dd>A block-level element is one which is not a table cell, and whose effective CSS display style is not in the set ['inline', 'inline-block', 'inline-table', 'none', 'table-cell', 'table-column', 'table-column-group']</dd>
        
        <dt><a name="text.horizontal">Horizontal whitespace characters</a></dt>
        <dd>Horizontal whitespace characters are defined by the ECMAScript regular expression <code>[\x20\t\u2028\u2029]</code>.</dd>
    </dl>
</p>

<p>The expected return value is roughly what a text-only browser such as Lynx would display. The algorithm for determining this text is as follows:</p>

<p>Let <code>lines</code> equal an empty array. Then:
<ol>  
    <li><a name="text.1">For</a> each <code>child</code> of node, at time of execution, in order:
        <ol>
            <li>Get whitespace, text-transform, and then, if <code>child</code> is:
                <ul>
                    <li>a node which is not <a href="#visibility">visible</a>, do nothing</li>
                    <li>a [[!DOM-LEVEL-3-CORE]] <a href="http://www.w3.org/TR/2004/REC-DOM-Level-3-Core-20040407/core.html#ID-1312295772">text node</a> let <code>text</code> equal the <code>nodeValue</code> property of <code>child</code>. Then:
                        <ol>
                            <li>Remove any zero-width spaces (\u200b), form feeds (\f) or vertical tab feeds (\v) from <code>text</code>.</li>
                            <li>Canonicalize any recognized single newline sequence in <code>text</code> to a single newline (greedily matching <code>(\r\n|\r|\n)</code> to a single \n)</li>
                            <li>If the parent's effective CSS whitespace style is 'normal' or 'nowrap' replace each newline (\n) in <code>text</code> with a single space character (\x20). If the parent's effective CSS whitespace style is 'pre' or 'pre-wrap' replace each <a href="#text.horizontal">horizontal whitespace character</a> with a non-breaking space character (\xa0). Otherwise replace each sequence of <a href="#text.horizontal">horizontal whitespace characters</a> except non-breaking spaces (\xa0) with a single space character</li>
                            <li>Apply the parent's effective CSS text-transform style as per the <a href="http://www.w3.org/TR/CSS2/text.html#propdef-text-transform">CSS2 specification</a> ([[!CSS2]])</li>
                            <li>If <code>last(lines)</code> ends with a space character and <code>text</code> starts with a space character, trim the first character of <code>text</code>.</li>
                            <li>Append <code>text</code> to <code>last(lines)</code> in-place</li>
                        </ol>
                    </li>
                    <li>an element which is <a href="#visibility">visible</a>. If the element is a:
                        <ul>
                            <li>BR element: Push '' to <code>lines</code> and continue</li>
                            <li><a href="#text.blocklevel">Block-level</a> element and if <code>last(lines)</code> is not '', push '' to <code>lines</code>.</li>
                        </ul>
                    And then recurse depth-first to <a href="text.1">step 1</a> with <code>child</code> set to the current element</li>
                    <li>If element is a TD element, or the effective CSS display style is 'table-cell', and last(lines) is not '', and <code>last(lines)</code> does not end with whitespace append a single space character to <code>last(lines)</code> [Note: Most innerText implementations append a \t here]</li>
                    <li>If element is a block-level element: push '' to <cpde>lines</code></li>
                </ul>
            </li>
        </ol>
    </li>
    <li>For each line in <code>lines</code> trim any leading and trailing whitespace excluding <a href="text.whitespace-nbsp">non-breaking space characters</a>.</li>
    <li>Let <code>s</code> be <code>lines.join('\n')</code></li>
    <li>Trim any leading and trailing <a href="text.whitespace-nbsp">whitespace excluding non-breaking space characters</a> from <code>s</code>.</li>
    <li>Replace any non-breaking spaces (\xa0) with spaces (\x20) in <code>s</code>.</li>
    <li>Return <code>s</code>.</li>
</ol>
</p>

</section>
</section>
